<?xml version="1.0" encoding="utf-8"?>
<addon addon_id="SV_WarningImprovements" title="Warning Improvements" version_string="1.0.1" version_id="100010" url="" install_callback_class="SV_WarningImprovements_Listener" install_callback_method="install" uninstall_callback_class="SV_WarningImprovements_Listener" uninstall_callback_method="uninstall">
  <admin_navigation/>
  <admin_permissions/>
  <admin_style_properties/>
  <admin_templates>
    <template title="sv_warningimprovements_criteria"><![CDATA[	<li><label>
		<input type="checkbox" name="user_criteria[warning_points_l][rule]" value="warning_points_l" class="Disabler" id="ucrit_warning_points_l" {xen:checked $userCriteria.warning_points_l} />
		{xen:phrase user_has_received_at_least_x_warnings_points}:</label>
		<div class="criteriaQualifier" id="ucrit_warning_points_l_Disabler">
			<xen:spinbox name="user_criteria[warning_points_l][data][points]" value="{$userCriteria.warning_points_l.points}" size="5" min="0" step="7" />
		</div>
	</li>
	<li><label>
		<input type="checkbox" name="user_criteria[warning_points_m][rule]" value="warning_points_m" class="Disabler" id="ucrit_warning_points_m" {xen:checked $userCriteria.warning_points_m} />
		{xen:phrase user_has_received_at_most_x_warnings_points}:</label>
		<div class="criteriaQualifier" id="ucrit_warning_points_m_Disabler">
			<xen:spinbox name="user_criteria[warning_points_m][data][points]" value="{$userCriteria.warning_points_m.points}" size="5" min="0" step="7" />
		</div>
	</li>]]></template>
  </admin_templates>
  <admin_template_modifications>
    <modification template="warning_edit" modification_key="SV_WarningImprovements_warning_edit1" description="Special case editing the Custom Warning - 1" execution_order="10" enabled="1" action="str_replace">
      <find><![CDATA[{xen:adminlink warnings/save, $warning}]]></find>
      <replace><![CDATA[{xen:adminlink warnings/save}]]></replace>
    </modification>
    <modification template="warning_edit" modification_key="SV_WarningImprovements_warning_edit2" description="Special case editing the Custom Warning - 2" execution_order="10" enabled="1" action="str_replace">
      <find><![CDATA[<xen:if is="{$warning.warning_definition_id}">
	<xen:navigation>]]></find>
      <replace><![CDATA[<xen:if is="{$warning.warning_definition_id} or {$warning.is_custom}">
	<xen:navigation>]]></replace>
    </modification>
    <modification template="warning_edit" modification_key="SV_WarningImprovements_warning_edit3" description="Special case editing the Custom Warning - 3" execution_order="10" enabled="1" action="str_replace">
      <find><![CDATA[<xen:title>{xen:if $warning.warning_definition_id]]></find>
      <replace><![CDATA[<xen:title>{xen:if '{$warning.warning_definition_id} or {$warning.is_custom}']]></replace>
    </modification>
    <modification template="warning_edit" modification_key="SV_WarningImprovements_warning_edit4" description="Special case editing the Custom Warning - 4" execution_order="10" enabled="1" action="preg_replace">
      <find><![CDATA[#(<xen:textboxunit label="{xen:phrase title}:".*?/>)#si]]></find>
      <replace><![CDATA[<xen:if is="{$warning.is_custom}">
<input name="title" type="hidden" value="{$masterTitle}" />
<input name="is_custom" type="hidden" value="1" />
<fieldset>
<dl class="ctrlUnit"><dt>{xen:phrase title}:</dt><dd><em>{$masterTitle}</em></dd></dl>
</fieldset>
<xen:else />
$1
</xen:if>]]></replace>
    </modification>
    <modification template="warning_list" modification_key="SV_WarningImprovements_warning_list" description="Exclude custom warning from list." execution_order="10" enabled="1" action="preg_replace">
      <find><![CDATA[#(<xen\:foreach loop\="\$warnings" value\="\$warning">)(.*?)(\s*)(</xen\:foreach>)#si]]></find>
      <replace><![CDATA[$1$3<xen:if is="{$warning.warning_definition_id}">
$2$3<xen:else />
			<xen:listitem
					id="warning-{$warning.warning_definition_id}"
					label="{$warning.title}"
					href="{xen:adminlink 'warnings/edit'}" />
$3</xen:if>
$3$4]]></replace>
    </modification>
    <modification template="helper_criteria_user" modification_key="sv_warningimprovements_helper_criteria_user" description="" execution_order="10" enabled="1" action="preg_replace">
      <find><![CDATA[#(<xen:hook name="user_criteria_content">.*?)(\s*)(</xen:hook>)#si]]></find>
      <replace><![CDATA[$1$2<xen:include template="sv_warningimprovements_criteria"/>$2$3]]></replace>
    </modification>
  </admin_template_modifications>
  <code_events/>
  <code_event_listeners>
    <listener event_id="criteria_user" execute_order="10" callback_class="SV_WarningImprovements_Criteria" callback_method="criteriaUser" active="1" hint="" description="Add warning related criteria"/>
    <listener event_id="load_class" execute_order="100" callback_class="SV_WarningImprovements_Listener" callback_method="load_class" active="1" hint="XenForo_DataWriter_WarningDefinition" description="XenForo_DataWriter_WarningDefinition"/>
    <listener event_id="load_class" execute_order="100" callback_class="SV_WarningImprovements_Listener" callback_method="load_class" active="1" hint="XenForo_ViewPublic_Member_WarnFill" description="XenForo_ViewPublic_Member_WarnFill"/>
    <listener event_id="load_class" execute_order="100" callback_class="SV_WarningImprovements_Listener" callback_method="load_class" active="1" hint="XenForo_ControllerAdmin_Warning" description="XenForo_ControllerAdmin_Warning"/>
    <listener event_id="load_class" execute_order="100" callback_class="SV_WarningImprovements_Listener" callback_method="load_class" active="1" hint="XenForo_DataWriter_Warning" description="XenForo_DataWriter_Warning"/>
    <listener event_id="load_class" execute_order="100" callback_class="SV_WarningImprovements_Listener" callback_method="load_class" active="1" hint="XenForo_Model_Warning" description="XenForo_Model_Warning"/>
    <listener event_id="load_class" execute_order="100" callback_class="SV_WarningImprovements_Listener" callback_method="load_class" active="1" hint="XenForo_ControllerPublic_Member" description="XenForo_ControllerPublic_Member"/>
    <listener event_id="load_class" execute_order="100" callback_class="SV_WarningImprovements_Listener" callback_method="load_class" active="1" hint="XenForo_ControllerPublic_Warning" description="Xenforo_ControllerPublic_Warning"/>
    <listener event_id="load_class" execute_order="100" callback_class="SV_WarningImprovements_Listener" callback_method="load_class" active="1" hint="XenForo_Model_User" description="XenForo_Model_User"/>
  </code_event_listeners>
  <cron/>
  <email_templates/>
  <email_template_modifications/>
  <optiongroups>
    <group group_id="SV_WarningImprovements" display_order="141" debug_only="0"/>
    <option option_id="sv_warningimprovements_anonymise_alert" edit_format="onoff" data_type="boolean" can_backup="1">
      <default_value>0</default_value>
      <edit_format_params></edit_format_params>
      <sub_options></sub_options>
      <relation group_id="SV_WarningImprovements" display_order="400"/>
      <relation group_id="alerts" display_order="400"/>
    </option>
    <option option_id="sv_warningimprovements_continue_button" edit_format="onoff" data_type="boolean" can_backup="1">
      <default_value>1</default_value>
      <edit_format_params></edit_format_params>
      <sub_options></sub_options>
      <relation group_id="SV_WarningImprovements" display_order="9100"/>
    </option>
    <option option_id="sv_warningimprovements_conversation_invite" edit_format="onoff" data_type="boolean" can_backup="1">
      <default_value>0</default_value>
      <edit_format_params></edit_format_params>
      <sub_options></sub_options>
      <relation group_id="SV_WarningImprovements" display_order="9120"/>
    </option>
    <option option_id="sv_warningimprovements_conversation_locked" edit_format="onoff" data_type="boolean" can_backup="1">
      <default_value>0</default_value>
      <edit_format_params></edit_format_params>
      <sub_options></sub_options>
      <relation group_id="SV_WarningImprovements" display_order="9130"/>
    </option>
    <option option_id="sv_warningimprovements_conversation_send_default" edit_format="onoff" data_type="boolean" can_backup="1">
      <default_value>1</default_value>
      <edit_format_params></edit_format_params>
      <sub_options></sub_options>
      <relation group_id="SV_WarningImprovements" display_order="9110"/>
    </option>
    <option option_id="sv_warningimprovements_copy_title" edit_format="onoff" data_type="boolean" can_backup="1">
      <default_value>1</default_value>
      <edit_format_params></edit_format_params>
      <sub_options></sub_options>
      <relation group_id="SV_WarningImprovements" display_order="9140"/>
    </option>
    <option option_id="sv_warningimprovements_default_content_action" edit_format="radio" data_type="string" can_backup="1">
      <default_value>public_warning</default_value>
      <edit_format_params>none={xen:phrase do_nothing}
delete_content={xen:phrase delete_the_content}
public_warning={xen:phrase post_public_warning}</edit_format_params>
      <sub_options></sub_options>
      <relation group_id="SV_WarningImprovements" display_order="9150"/>
    </option>
  </optiongroups>
  <permissions>
    <permission_groups/>
    <permissions>
      <permission permission_group_id="general" permission_id="viewWarning_issuer" permission_type="flag" default_value="unset" interface_group_id="generalPermissions" display_order="11005"/>
    </permissions>
    <interface_groups/>
  </permissions>
  <phrases>
    <phrase title="option_group_SV_WarningImprovements" version_id="100000" version_string="1.0.0"><![CDATA[Warning Improvements]]></phrase>
    <phrase title="option_group_SV_WarningImprovements_description" version_id="100000" version_string="1.0.0"><![CDATA[A collection of improvements and configurables for XF's warning system.]]></phrase>
    <phrase title="option_sv_warningimprovements_anonymise_alert" version_id="100000" version_string="1.0.0"><![CDATA[Anonymise Warning Alerts]]></phrase>
    <phrase title="option_sv_warningimprovements_anonymise_alert_explain" version_id="100000" version_string="1.0.0"><![CDATA[Prevent users from seeing who issued warnings against them.<br/>
<br/>
Changing this does <b>not</b> apply retroactively.]]></phrase>
    <phrase title="option_sv_warningimprovements_continue_button" version_id="2" version_string="0.02"><![CDATA[Add Continue Button on Warning]]></phrase>
    <phrase title="option_sv_warningimprovements_continue_button_explain" version_id="2" version_string="0.02"><![CDATA[Force a continue button to replace the "warn" button for all but the last tab.]]></phrase>
    <phrase title="option_sv_warningimprovements_conversation_invite" version_id="100010" version_string="1.0.1"><![CDATA[Allow Invite into Warning Conversations By Default]]></phrase>
    <phrase title="option_sv_warningimprovements_conversation_invite_explain" version_id="100010" version_string="1.0.1"><![CDATA[By Default, check inviting others into a warning conversation.]]></phrase>
    <phrase title="option_sv_warningimprovements_conversation_locked" version_id="2" version_string="0.02"><![CDATA[Lock Warning Conversations]]></phrase>
    <phrase title="option_sv_warningimprovements_conversation_locked_explain" version_id="2" version_string="0.02"><![CDATA[By Default, lock warning conversations.]]></phrase>
    <phrase title="option_sv_warningimprovements_conversation_send_default" version_id="100010" version_string="1.0.1"><![CDATA[Send Warning Conversations By Default]]></phrase>
    <phrase title="option_sv_warningimprovements_conversation_send_default_explain" version_id="100010" version_string="1.0.1"><![CDATA[By Default, sending warning conversations.]]></phrase>
    <phrase title="option_sv_warningimprovements_copy_title" version_id="2" version_string="0.02"><![CDATA[Copy Warning Title to Public Warning]]></phrase>
    <phrase title="option_sv_warningimprovements_copy_title_explain" version_id="2" version_string="0.02"><![CDATA[Pre-fill the content action "Post a public warning" with the title of the warning.]]></phrase>
    <phrase title="option_sv_warningimprovements_default_content_action" version_id="2" version_string="0.02"><![CDATA[Default Content Action]]></phrase>
    <phrase title="option_sv_warningimprovements_default_content_action_explain" version_id="2" version_string="0.02"><![CDATA[]]></phrase>
    <phrase title="permission_general_viewWarning_issuer" version_id="100" version_string="1.0.0"><![CDATA[View warning issuer]]></phrase>
    <phrase title="send_alert_on_warning" version_id="100000" version_string="1.0.0"><![CDATA[Send alert on warning]]></phrase>
    <phrase title="user_has_received_at_least_x_warnings_points" version_id="3" version_string="0.0.3"><![CDATA[User has received at least X warnings points]]></phrase>
    <phrase title="user_has_received_at_most_x_warnings_points" version_id="3" version_string="0.0.3"><![CDATA[User has received at most X warnings points]]></phrase>
    <phrase title="WarningStaff" version_id="100" version_string="1.0.0"><![CDATA[Moderation Staff]]></phrase>
    <phrase title="warning_alert_text" version_id="100000" version_string="1.0.0"><![CDATA[{name} issued you a warning for <a {warning_attributes}>{warning_title}</a> for {points} points.]]></phrase>
    <phrase title="warning_alert_text_anonymize" version_id="100000" version_string="1.0.0"><![CDATA[You have received a warning for <a {warning_attributes}>{warning_title}</a> for {points} points.]]></phrase>
    <phrase title="warning_definition_0_title" version_id="2" version_string="0.02"><![CDATA[Custom Warning]]></phrase>
  </phrases>
  <route_prefixes/>
  <style_properties/>
  <templates>
    <template title="alert_warning_alert_warning" version_id="100000" version_string="1.0.0"><![CDATA[
<xen:if is="{$user.user_id}">
{xen:phrase warning_alert_text,
'name={xen:helper username, $user, 'subject'}',
'warning_attributes=href="{xen:link warnings, $content}" class="PopupItemLink"',
'points={$content.points}',
'warning_title={$content.title}'
}  
<xen:else/>
{xen:phrase warning_alert_text_anonymize,
'warning_attributes=href="{xen:link warnings, $content}" class="PopupItemLink"',
'points={$content.points}',
'warning_title={$content.title}'
} 
</xen:if>
]]></template>
    <template title="sv_warning_improvement_js" version_id="2" version_string="0.02"><![CDATA[<script>
!function($, window, document, _undefined)
{
	<xen:if is="{$xenOptions.sv_warningimprovements_continue_button}">
	$warningForm = $(".warningHeader").closest('form');
	$warningSubmitButton = $warningForm.find('dl.submitUnit input[type=submit]').first();
	$dl = $warningSubmitButton.parent();
	$dl.append('<input type="button" class="continue button" value="{xen:phrase continue}"/>');
	$warningContinueButton = $dl.find('.continue');
	$warningSubmitButton.hide();

	$warningForm.find('.tabs li a').click(function(e) {
		if ($(e.target).parent().next().length === 0){
			$warningSubmitButton.show();
			$warningContinueButton.hide();
		}
		else {
			$warningSubmitButton.hide();
			$warningContinueButton.show();
		}
	});

	$warningContinueButton.click(function(e) {
		var $next = $warningForm.find('.tabs li .active').parent().next();
		if ($next.length !== 0) {
			$next.find('a').click().focus();
		}
	});
	</xen:if>	

	XenForo.WarningDefaultActionFormFillerControl = function($control)
	{
		$control.trigger('click');
		<xen:if is='{$xenOptions.sv_warningimprovements_default_content_action} == "delete_content"'>
		$('input[name=content_action][value=delete_content]').trigger('click');
		<xen:elseif is='{$xenOptions.sv_warningimprovements_default_content_action} == "public_warning"'/>
		$('input[name=content_action][value=public_warning]').trigger('click');
		</xen:if>
	}
	XenForo.register('#customWarning', 'XenForo.WarningDefaultActionFormFillerControl');
	<xen:if is='{$xenOptions.sv_warningimprovements_copy_title}'>
	XenForo.CustomWarningTitle = function($control)
	{
		$control.change(function (e){
			$('input[name=public_warning]').val($control.val());
		});
	}
	XenForo.register('input[name=title]', 'XenForo.CustomWarningTitle');
	XenForo.WarningDefRadioButton = function($control)
	{
		$control.change(function (e){
			$('input[name=public_warning]').val($(e.target).closest('label').text());
		});
	}
	XenForo.register('input[name=warning_definition_id][id!=customWarning]', 'XenForo.WarningDefRadioButton');
	XenForo.CustomWarningRadioButton = function($control)
	{
		$control.change(function (e){
			$('input[name=public_warning]').val($('input[name=title]').val());
		});
	}
	XenForo.register('input[id=customWarning]', 'XenForo.CustomWarningRadioButton');
	</xen:if>	
}
(jQuery, this, document);
</script>]]></template>
  </templates>
  <public_template_modifications>
    <modification template="warning_info" modification_key="SVViewOwnWarnings_member_warn" description="Only show parts of the warning to users (notes)." execution_order="10" enabled="1" action="str_replace">
      <find><![CDATA[<xen:if is="{$warning.notes}">]]></find>
      <replace><![CDATA[<xen:if is="{$warning.notes} AND {$visitor.permissions.general.viewWarning}">]]></replace>
    </modification>
    <modification template="warning_info" modification_key="SVViewOwnWarnings_member_warn_mod" description="Only show parts of the warning to users (issuer)." execution_order="10" enabled="1" action="str_replace">
      <find><![CDATA[{$warning.warn_username}]]></find>
      <replace><![CDATA[<xen:if is="{$visitor.permissions.general.viewWarning_issuer} OR {$visitor.permissions.general.viewWarning}">$0<xen:else/>{xen:phrase WarningStaff}</xen:if>]]></replace>
    </modification>
    <modification template="member_warn" modification_key="SV_WarningImprovements_member_warn1" description="Insert extra javascript" execution_order="1" enabled="1" action="str_replace">
      <find><![CDATA[</script>]]></find>
      <replace><![CDATA[$0
<xen:include template="sv_warning_improvement_js"/>]]></replace>
    </modification>
    <modification template="member_warn" modification_key="SV_WarningImprovements_member_warn2" description="Exclude custom warning from list." execution_order="10" enabled="1" action="preg_replace">
      <find><![CDATA[#(<xen\:foreach loop\="\$warnings" value\="\$warning">)(.*?)(\s*)(</xen\:foreach>)#si]]></find>
      <replace><![CDATA[$1$3<xen:if is="{$warning.warning_definition_id}">
$2$3</xen:if>
$3$4]]></replace>
    </modification>
    <modification template="member_warn" modification_key="SV_WarningImprovements_member_warn3" description="Conversation locking" execution_order="10" enabled="1" action="str_replace">
      <find><![CDATA[<input type="checkbox" name="conversation_locked" value="1"]]></find>
      <replace><![CDATA[$0 {xen:if '{$xenOptions.sv_warningimprovements_conversation_locked}', 'checked="checked"'}]]></replace>
    </modification>
    <modification template="member_warn" modification_key="SV_WarningImprovements_member_warn4" description="Sending Alerts on recieving a warning." execution_order="10" enabled="1" action="preg_replace">
      <find><![CDATA[#(<dt>{xen:phrase member_notification}:</dt>.*?<dd>.*?)(</dd>)#s]]></find>
      <replace><![CDATA[$1$2
<dt></dt>
<dd><label><input type="checkbox" name="send_warning_alert" value="1" checked="checked" /> {xen:phrase send_alert_on_warning}</label></dd>]]></replace>
    </modification>
    <modification template="member_warn" modification_key="SV_WarningImprovements_member_warn5" description="Conversation Inviting" execution_order="10" enabled="1" action="str_replace">
      <find><![CDATA[<input type="checkbox" name="open_invite" value="1"]]></find>
      <replace><![CDATA[$0 {xen:if '{$xenOptions.sv_warningimprovements_conversation_invite}', 'checked="checked"'}]]></replace>
    </modification>
    <modification template="member_warn" modification_key="SV_WarningImprovements_member_warn6" description="Conversation sending" execution_order="10" enabled="1" action="preg_replace">
      <find><![CDATA[#(id="startConversation".*?)(class="Disabler".*?)(checked="checked")#i]]></find>
      <replace><![CDATA[$1 {xen:if '{$xenOptions.sv_warningimprovements_conversation_send_default}', '$2 $3'}]]></replace>
    </modification>
  </public_template_modifications>
  <bb_code_media_sites/>
  <bb_codes/>
</addon>
